version: '3.8'

services:
    mongo:
        image: mongo:7.0
        container_name: mongo
        restart: always
        environment:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        command: >
          bash -c "
            # Start standard Mongo entrypoint on background
            /usr/local/bin/docker-entrypoint.sh mongod &

            # Wait until MongoDB is up
            until mongosh --quiet --eval 'db.adminCommand(\"ping\")' > /dev/null 2>&1; do
              echo '‚è≥ Waiting for Mongo to be ready...';
              sleep 2;
            done;

            echo 'üì¶ Restoring dump from /mongo-dump/piadb ...';
            mongorestore --drop --db piadb /mongo-dump/piadb;
            echo '‚úÖ Restore finished.';

            wait
          "
        volumes:
          - mongo-data:/data/db
          - ./mongo-dump:/mongo-dump
        ports:
          - "27017:27017"
          
    mailhog:
        image: mailhog/mailhog
        container_name: mailhog
        restart: always
        ports:
          - "1025:1025"
          - "8025:8025"
          
          
    backend:
        container_name: backend
        environment:
            - MONGO_HOST=mongo
            - MAIL_HOST=mailhog
        build:
            context: .
            dockerfile: Server/Dockerfile
        ports:
          - "8080:8080"
        depends_on:
          - mongo
          - mailhog
    frontend:
        container_name: frontend
        build:
          context: .
          dockerfile: Client/Dockerfile
        ports:
          - "4200:80"
        depends_on:
          - backend
        restart: on-failure
    
    
volumes:
  mongo-data:
    driver: local
