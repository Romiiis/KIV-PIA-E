version: '3.8'

services:
    mongo:
        image: mongo:7.0
        container_name: mongo
        restart: always
        environment:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        command: >
          bash -c "
            # Start standard Mongo entrypoint on background
            /usr/local/bin/docker-entrypoint.sh mongod &

            # Wait until MongoDB is up
            until mongosh --quiet --eval 'db.adminCommand(\"ping\")' > /dev/null 2>&1; do
              echo '‚è≥ Waiting for Mongo to be ready...';
              sleep 2;
            done;

            echo 'üì¶ Restoring dump from /mongo-dump/piadb ...';
            mongorestore --drop --db piadb /mongo-dump/piadb;
            echo '‚úÖ Restore finished.';

            # Keep container alive
            wait
          "
        volumes:
          - mongo-data:/data/db
          - ./mongo-dump:/mongo-dump
        ports:
          - "27017:27017"
          
    mailhog:
        image: mailhog/mailhog
        container_name: mailhog
        restart: always
        ports:
          - "1025:1025"
          - "8025:8025"
volumes:
  mongo-data:
    driver: local
