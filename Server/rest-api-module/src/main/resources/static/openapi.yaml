openapi: 3.0.3
info:
  title: KIV/PIA REST API
  description: blah
  version: 0.0.1
servers:
  - url: http://localhost:8080/
    description: Local development server
security:
  - bearerAuth: [ ]
  - cookieAuth: [ ]
tags:
  - name: Auth
    description: API endpoints used for authentication and user registration.
  - name: Projects
    description: API endpoints used for management of translation projects.
  - name: Users
    description: API endpoints used for management of users (customers, translators, admins).
  - name: Me
    description: API endpoint to get details of the currently authenticated user.
  - name: TranslatorsLanguage
    description: API endpoints used for management of translator languages.
  - name: ProjectsFeedback
    description: API endpoints used for management of project feedback.
  - name: ProjectsWorkflow
    description: API endpoints used for managing project workflow (assignments, state transitions).
  - name: Mails
    description: API endpoints used for sending various notification emails.
paths:

  # ----- Auth Endpoints -----
  /auth/login:
    post:
      tags:
        - Auth
      summary: Authenticates a user and returns JWT tokens.
      description: >
        Accepts user credentials (email and password), validates them, and issues
        both access and refresh tokens. The tokens are set as **HttpOnly cookies**
        for secure storage on the client. (permitAll)
      operationId: loginUser
      security: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginUserRequest'
      responses:
        '200':
          description: Successful authentication
          headers:
            Set-Cookie:
              description: >
                The access_token and refresh_token cookies are set on successful login.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthJWTResponse'
        '400':
          description: Invalid request body
        '401':
          description: Invalid email or password
        '500':
          description: Server error

  /auth/register:
    post:
      tags:
        - Auth
      summary: Registers a new user and logs them in
      security: [ ]
      description: >
        Registers a new user (customer or translator). Upon successful registration,
        both JWT tokens are issued and set as **HttpOnly cookies**. (permitAll)
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterUserRequest'
      responses:
        '201':
          description: Registered successfully
          headers:
            Set-Cookie:
              description: >
                The access_token and refresh_token cookies are set on successful registration.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthJWTResponse'
        '400':
          description: Request body invalid or incomplete
        '409':
          description: Email address already in use
        '500':
          description: Server error

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Refreshes the JWT access token
      description: >
        Uses the `refresh_token` stored as an **HttpOnly cookie** to issue a new access token.
        If the refresh token is valid, new cookies are set in the response.
      operationId: refreshToken
      security:
        - cookieAuth: [ ]
      responses:
        '200':
          description: Tokens refreshed successfully
          headers:
            Set-Cookie:
              description: >
                The new access_token and refresh_token cookies are returned.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthJWTResponse'
        '401':
          description: Invalid or expired refresh token
        '500':
          description: Server error

  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logs out the current user
      description: >
        Invalidates the current refresh token and clears all authentication cookies.
        Requires either a valid bearer or cookie-based session.
      operationId: logoutUser
      responses:
        '204':
          description: Logged out successfully, cookies cleared
        '401':
          description: Unauthorized - no valid authentication
        '500':
          description: Server error

  # ---- Me Endpoint -----
  /me:
    get:
      tags:
        - Me
      summary: Get the currently authenticated user's details
      description: >
        Retrieves the details of the currently authenticated user
        based on the provided JWT access token. (ALL ROLES USERS CAN ACCESS)
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user details retrieved successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '500':
          description: Server error.


    # ------ END Auth Endpoints ------


  # ----- User Endpoints -----
  /users:
    get:
      tags:
        - Users
      summary: Get all users
      operationId: listAllUsers
      description: >
        Retrieves a list of all users in the system. Using provided filters.
        (ADMIN only can access this endpoint.)
      parameters:
        - name: role
          in: query
          description: Filter users by their role (CUSTOMER, TRANSLATOR, ADMIN)
          required: false
          schema:
            $ref: '#/components/schemas/UserRole'
        - name: language
          in: query
          description: Filter users by a language they know (ISO code, e.g., "en" for English)
          required: false
          schema:
            type: string
            example: en
      responses:
        '200':
          description: A list of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListUsersResponse'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '500':
          description: Server error
  /users/{id}:
    get:
      tags:
        - Users
      summary: Get user by ID
      description: >
        Retrieves the details of a user by their unique ID.
        (ADMIN can see any user; SELF can see their own details -> Every role can access this endpoint.)
      operationId: getUserDetails
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: User not found

  # ----- Translator Language Endpoints -----
  /users/{id}/languages:
    get:
      tags:
        - TranslatorsLanguage
      summary: Get languages known by a user
      operationId: listUserLanguages
      description: >
        Retrieves the list of languages known by the specified user.
        (ADMIN or the translators themself (TRANSLATOR) can access this endpoint.)
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the user
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Languages retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListLanguagesResponse'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: User not found
    put:
      tags:
        - TranslatorsLanguage
      summary: Replace all languages of a user
      operationId: replaceUserLanguages
      description: >
        Replaces all existing languages of the specified user with a new set.
        (Accessible by TRANSLATOR themselves)
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the user
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceLanguagesRequest'
      responses:
        '200':
          description: Languages replaced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListLanguagesResponse'
        '400':
          description: Invalid input data.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: User not found.
        '405':
          description: Unsupported HTTP method.
        '500':
          description: Internal server error.
  /users/{id}/role:
    post:
      tags:
        - Users
      summary: Change user role
      description: >
        Sets a new role for the specified user.
        Only caller same as userId can change their own role. 
        AND ONLY IF ROLE IS NULL (i.e., during initial registration).
      operationId: changeUserRole
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the user
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitializeUserRequest'
      responses:
        '200':
          description: User role changed successfully
        '400':
          description: Invalid input data.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: User not found.
        '500':
          description: Internal server error.


  # ------ Project Endpoints -----
  /projects:
    post:
      tags:
        - Projects
      summary: Creates a new project using the current user as the customer.
      description: >
        Creates a new translation project with the provided target language and content.
        The authenticated user is set as the customer for the project. (Only CUSTOMER can access this endpoint.)
      operationId: createProject
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/CreateProjectRequest"
        required: true
      responses:
        '201':
          description: Project was successfully created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        '400':
          description: Request body is not formatted correctly.
        '403':
          description: Current user is not authorized to create projects.
        '405':
          description: Unsupported HTTP method.
        '406':
          description: Not acceptable response representation.
        '500':
          description: Server error.
    get:
      tags:
        - Projects
      summary: List all projects with optional filters.
      description: >
        Retrieves a list of all projects in the system, with optional filtering
        by state, target language, and feedback presence. (ALL ROLES USERS CAN ACCESS)
        Every user sees only projects they are authorized to view.
      operationId: listAllProjects
      parameters:
        - in: query
          name: state
          schema:
            $ref: '#/components/schemas/ProjectState'
          description: Filter projects by their state.
          required: false
        - in: query
          name: languageCode
          schema:
            type: string
            minLength: 2
            maxLength: 2
            description: Filter projects by target language (ISO 639-1 code).
          required: false
        - in: query
          name: hasFeedback
          schema:
            type: boolean
            description: Filter projects based on whether they have feedback.
          required: false


      responses:
        '200':
          description: Projects retrieved successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListProjectsResponse"
        '403':
          description: Current user is not authorized to list projects.
        '405':
          description: Unsupported HTTP method.
        '406':
          description: Not acceptable response representation.
        '500':
          description: Server error.
  /projects/{id}:
    get:
      tags:
        - Projects
      summary: Get project by ID
      description: >
        Retrieves the details of a project by its unique ID.
        (ALL ROLES USERS CAN ACCESS this endpoint; user sees only projects they are authorized to view.)
      operationId: getProjectDetails
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: Project not found
        '500':
          description: Server error.
  /projects/{id}/original:
    get:
      tags:
        - Projects
      summary: Download the original content of a project
      description: >
        Retrieves the original content file of the specified project.
        (customer  or assigned translator can perform this)
      operationId: downloadOriginalContent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Original content retrieved successfully.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.
  /projects/{id}/translated:
    get:
      tags:
        - Projects
      summary: Download the translated content of a project (customer, admin, or assigned translator can perform this)
      description: >
        Retrieves the translated content file of the specified project.
        (customer or assigned translator can perform this)
      operationId: downloadTranslatedContent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Translated content retrieved successfully.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.
    put:
      tags:
        - ProjectsWorkflow
      summary: Upload translated content for a project (Only translator for this project can perform this )
      description: >
        Allows the assigned translator to upload the translated content file
        for the specified project. (Only translator for this project can perform this )
      operationId: uploadTranslatedContent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
          description: Translated content uploaded successfully.
        '400':
          description: Invalid input data.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.

  /projects/{id}/approve:
    post:
      tags:
        - ProjectsWorkflow
      summary: Approve the translated content of a project (only customer who created the project can perform this)
      description: >
        Allows the customer who created the project to approve
        the translated content, marking the project as approved. (only customer who created the project can perform this)
      operationId: approveTranslatedContent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
          description: Translated content approved successfully.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.
  /projects/{id}/reject:
    post:
      tags:
        - ProjectsWorkflow
      summary: Reject the translated content of a project (only customer who created the project can perform this)
      description: >
        Allows the customer who created the project to reject
        the translated content, providing feedback for improvements. (only customer who created the project can perform this)
      operationId: rejectTranslatedContent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectFeedbackRequest'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
          description: Translated content rejected successfully.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.
  /projects/{id}/close:
    post:
      tags:
        - ProjectsWorkflow
      summary: Close a project (only admin can perform this)
      description: >
        Close the project ultimately, marking it as closed.
        (only admin can perform this)
      operationId: closeProject
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

          description: Project closed successfully.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to modify this resource.
        '404':
          description: Project not found.
        '500':
          description: Server error.


  # ------ Feedback Endpoints -----
  /projects/{id}/feedback:
    get:
      tags:
        - ProjectsFeedback
      summary: Get feedback for a project
      description: >
        Get the feedback associated with a specific project.
        (EVERY ROLE can access this endpoint; user sees feedback only for projects they are authorized to view.)
      operationId: getProjectFeedback
      parameters:
        - name: id
          description: Id of the project
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Feedback retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectFeedback'
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '404':
          description: Project or feedback not found.
        '500':
          description: Server error.


  # ------ Mail Endpoints
  /mails:
    post:
      tags:
        - Mails
      summary: Send a test email to the current user
      description: >
        Sends an email to the user / users address (only ADMIN can access this endpoint.)
      operationId: sendEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendEmailRequest'
      responses:
        '200':
          description: Email sent successfully
        '400':
          description: Invalid input data.
        '401':
          description: Unauthorized - no valid authentication token provided.
        '403':
          description: Forbidden - insufficient permissions to access this resource.
        '500':
          description: Server error.






















components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    cookieAuth:
      type: apiKey
      in: cookie
      name: refresh_token





  schemas:

    #----- User Schemas -----
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "d290f1ee-6c54-4b01-90e6-d701748f0851"
        name:
          type: string
          example: "John Doe"
        emailAddress:
          type: string
          format: email
          example: "john.doe@example.com"
        role:
          $ref: '#/components/schemas/UserRole'
        languages:
          type: array
          items:
            type: string
            example: "en"
          description: ISO language codes
        createdAt:
          type: string
          format: date-time
          example: "2025-10-15T09:33:20Z"
      required:
        - id
        - name
        - emailAddress
        - role
        - createdAt
    UserRole:
      type: string
      enum:
        - CUSTOMER
        - TRANSLATOR
        - ADMINISTRATOR

    ### USER REQUESTS ###
    InitializeUserRequest:
      type: object
      required: [ role ]
      additionalProperties: false
      properties:
        role:
          $ref: '#/components/schemas/UserRole'
        languages:
          description: Only required if role is TRANSLATOR
          type: array
          items:
            type: string
            example: en

    ReplaceLanguagesRequest:
      type: array
      items:
        type: string
        example: en
    ### USER RESPONSES ###
    ListUsersResponse:
      type: array
      items:
        $ref: '#/components/schemas/User'
    ListLanguagesResponse:
      type: array
      items:
        type: string
        example: en





    #----- Auth Schemas -----
    LoginUserRequest:
      type: object
      required: [ emailAddress, password ]
      additionalProperties: false
      properties:
        emailAddress:
          type: string
          format: email
        password:
          type: string
          format: password
    RegisterUserRequest:
      type: object
      required: [ name, emailAddress, password ]
      additionalProperties: false
      properties:
        name:
          type: string
        emailAddress:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
    ### AUTH RESPONSES ###
    AuthJWTResponse:
      type: object
      description: >
        JWT response payload, mostly for debugging or testing.
        Tokens are also set in HttpOnly cookies.
      properties:
        accessToken:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refreshToken:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...



    #----- Project Schemas -----
    Project:
      type: object
      required: [ id, targetLanguage, customer, originalFileName, state, createdAt ]
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier of the created project
        targetLanguage:
          type: string
          example: "de"
        originalFileName:
          type: string
          example: "document.txt"
        translatedFileName:
          type: string
          example: "document_de.txt"
        customer:
          $ref:
            '#/components/schemas/User'
        translator:
          $ref:
            '#/components/schemas/User'
        feedback:
          $ref:
            '#/components/schemas/ProjectFeedback'
        state:
          $ref: '#/components/schemas/ProjectState'
        createdAt:
          type: string
          format: date-time



    ProjectState:
      type: string
      enum:
        - CREATED
        - ASSIGNED
        - COMPLETED
        - APPROVED
        - CLOSED

    ### PROJECT REQUESTS ###
    CreateProjectRequest:
      type: object
      required: [ languageCode, content ]
      additionalProperties: false
      properties:
        languageCode:
          type: string
          minLength: 2
          maxLength: 2
          example: "de"
          description: Target language ISO 639-1 code.
        content:
          type: string
          format: binary
          description: Text content to be translated.

    ### PROJECT RESPONSES ###
    ListProjectsResponse:
      type: array
      items:
        $ref: '#/components/schemas/Project'


    #------ Project Feedback Schemas -----
    ProjectFeedback:
      type: object
      properties:
        projectId:
          type: string
          format: uuid
        text:
          type: string
          example: "This is horrible"
        createdAt:
          type: string
          format: date-time
      required: [ projectId, text, createdAt ]

    ### PROJECT FEEDBACK REQUESTS ###
    ProjectFeedbackRequest:
      type: object
      required: [ text ]
      additionalProperties: false
      properties:
        text:
          type: string
          example: "This is horrible"



    #------ Mail Schemas -----
    SendEmailRequest:
      type: object
      description: Request payload to send an email
      required: [ projectId, customer, translator, text ]
      properties:
        projectId:
          type: string
          format: uuid
          example: "d290f1ee-6c54-4b01-90e6-d701748f0851"
          description: ID of the project related to the email
        customer:
          type: boolean
          example: true
          description: Whether to send email to customer
        translator:
          type: boolean
          example: false
          description: Whether to send email to translator
        text:
          type: string
          example: "Your project has been updated."
          description: Body text of the email





